<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance System</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
    }
    input, button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 8px;
    }
    #preview {
      margin-top: 10px;
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      display: none;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
    video {
      width: 100%;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>Frequency + Face Attendance</h2>
  <a href="http://localhost:5500/csv-to-html-table/" target="_blank">View Report</a>
  <form id="userForm">
    <button id="startScanning">Start Scanning</button>
    <button type="button" id="startCamera">ðŸ“¸ Use Camera</button>
    <video id="video" autoplay playsinline></video>
    <button type="button" id="captureBtn" style="display:none;">ðŸ“· Capture</button>
    <img id="preview" src="#" alt="Preview" />
    <button type="submit">Detect</button>
  </form>

  <div id="status">ðŸ”„ Initializing...</div>

  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@next/build/Tone.js"></script>

  <script>
    let start_scanning = false;
    let users ;
    let base64Photo = "";
    let detected_frequency = 0;
    let sample_rate = 44100;
    let duration = 2.0;
    let tolerance = 0.0;

    const video = document.getElementById("video");
    const preview = document.getElementById("preview");
    const startCameraBtn = document.getElementById("startCamera");
    const captureBtn = document.getElementById("captureBtn");
    const statusBox = document.getElementById("status");
    const startScanningBtn = document.getElementById("startScanning");

    document.addEventListener("DOMContentLoaded", async () => {
      await loadUsers();
      statusBox.innerText = " Ready to scan!";
    });

    async function loadUsers() {
      try {
        const response = await fetch('/users');
        if (!response.ok) throw new Error('Failed to load users');
        users = await response.json();
        console.log("Loaded users:", users);
      } catch (error) {
        console.error("Error loading users:", error);
        statusBox.innerText = "Failed to load user data.";
      }
    }

    startCameraBtn.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = "block";
        captureBtn.style.display = "block";
        preview.style.display = "none";
        base64Photo = "";
      } catch (err) {
        alert("Camera access denied.");
        console.error(err);
      }
    });

    captureBtn.addEventListener("click", function () {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      const dataURL = canvas.toDataURL("image/png");
      base64Photo = dataURL.split(',')[1];
      preview.src = dataURL;
      preview.style.display = "block";
      console.log("Captured photo");
    });

    document.getElementById('userForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      if (!base64Photo) {
        statusBox.innerText = "Please capture a photo first.";
        return;
      }

      statusBox.innerText = "Processing face and frequency...";

      try {
        const response = await fetch(`/detect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image: base64Photo,
            frequency: detected_frequency
          })
        });

        const result = await response.json();
        statusBox.innerText = `${result.status} [${result.name}]`;
        alert(`Detected user: ${result.name}\nStatus: ${result.status}`);
      } catch (err) {
        console.error(err);
        statusBox.innerText = "Failed to connect to backend.";
      }
    });

    startScanningBtn.addEventListener("click", async (e) => {
      e.preventDefault();

      if (start_scanning) {
        start_scanning = false;
        statusBox.innerText = "Scanning stopped.";
        startScanningBtn.innerText = "Start Scanning";
        return;
      }

      start_scanning = true;
      startScanningBtn.innerText = "Stop Scanning";
      statusBox.innerText = "Starting frequency detection...";

      try {
        await main();
      } catch (error) {
        console.error("Error during scanning:", error);
        statusBox.innerText = "Error during scanning.";
      }
    });

    async function main() {
      while (start_scanning) {
        statusBox.innerText = "ðŸŽ¤ Listening for frequency...";
        detected_frequency = Math.round(await detect_frequency());


        const valid = await verify_frequency(detected_frequency);
        if (valid) {
          statusBox.innerText = "Frequency matched! Activate camera.";
          await startCameraBtn.click();
          break;
        } else {
          statusBox.innerText = " Invalid frequency, retrying...";
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }

    async function detect_frequency() {
      return new Promise((resolve, reject) => {
        const audioContext = new AudioContext();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.fftSize;
        const dataArray = new Float32Array(bufferLength);

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then((stream) => {
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);

            setTimeout(() => {
              analyser.getFloatTimeDomainData(dataArray);
              const frequency = autoCorrelate(dataArray, audioContext.sampleRate);
              stream.getTracks().forEach(track => track.stop());
              resolve(frequency);
            }, 2000); 
          })
          .catch((err) => {
            reject(err);
          });
      });
    }

    function autoCorrelate(buf, sampleRate) {
      let SIZE = buf.length;
      let rms = 0;
      for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.01) return -1;

      let r1 = 0, r2 = SIZE - 1, thres = 0.2;
      for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
      for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }

      buf = buf.slice(r1, r2);
      SIZE = buf.length;

      const c = new Array(SIZE).fill(0);
      for (let i = 0; i < SIZE; i++)
        for (let j = 0; j < SIZE - i; j++)
          c[i] = c[i] + buf[j] * buf[j + i];

      let d = 0;
      while (c[d] > c[d + 1]) d++;
      let maxval = -1, maxpos = -1;
      for (let i = d; i < SIZE; i++) {
        if (c[i] > maxval) {
          maxval = c[i];
          maxpos = i;
        }
      }

      let T0 = maxpos;
      let x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
      let a = (x1 + x3 - 2 * x2) / 2;
      let b = (x3 - x1) / 2;
      if (a) T0 = T0 - b / (2 * a);

      return sampleRate / T0;
    }

    async function generate_dynamic_frequency(user) {
      const now = new Date();
      const minute = now.getUTCMinutes();
      now.setUTCSeconds(0, 0);
      const timestampStr = now.toISOString().split('.')[0] + 'Z';
      const combo = `${user.secret}-${timestampStr}`;
      const hashHex = sha256(combo);
      const hashValue = parseInt(hashHex.slice(-4), 16);
      const bias = hashValue % 20;
      return user.frequency + bias + minute;
    }

    async function verify_frequency(peak_freq) {
      for (const user of users) {
        console.log(`Expected frequency for ${user.name}:`, user.frequency);
        console.log(`Peak frequency detected:`, Math.round(peak_freq));
        const expected = await generate_dynamic_frequency(user);
        if (Math.abs(Math.round(peak_freq) - Math.round(expected)) <= tolerance) {
          console.log(" Frequency matched:", user.name);
          return true;
        }
      }
      return false;
    }
  </script>
</body>
</html>
